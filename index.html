<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Reels Pro - Shared Post</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Material Symbols for "Post Removed" -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <style>
        /* CSS remains unchanged as requested except for requested UI adjustments */
        :root { --app-height: 100dvh; --primary: #fe2c55; --text-white: #ffffff; --text-gray: #b0b0b0; --dark-sheet: #1a1a1a; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { background-color: #000; font-family: 'Inter', sans-serif; color: var(--text-white); overflow: hidden; height: 100%; overscroll-behavior-y: none; }
        #app-frame { width: 100%; height: var(--app-height); background: #000; position: relative; }
        .feed-container { height: 100%; overflow-y: scroll; scroll-snap-type: y mandatory; scrollbar-width: none; scroll-behavior: smooth; overscroll-behavior-y: contain; }
        .feed-container::-webkit-scrollbar { display: none; }
        .reel-frame { height: 100%; width: 100%; scroll-snap-align: start; scroll-snap-stop: always; position: relative; background: #000; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        .media-wrapper { width: 100%; height: 100%; position: relative; display: flex; justify-content: center; align-items: center; }
        .reel-media { width: 100%; height: 100%; object-fit: contain; z-index: 1; }
        
        /* Updated Error Container for Triangle Icon */
        .error-container { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #777; text-align: center; width: 100%; height: 100%; z-index: 10; background: #000; position: absolute; top:0; left:0; }
        .error-container i { font-size: 50px; margin-bottom: 15px; opacity: 0.6; }
        .error-container span { font-weight: 600; font-size: 18px; }
        
        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24
        }

        .text-post-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; background: #000; padding: 40px 20px; }
        .text-post-box { background: #222; border: 1px solid #333; border-radius: 16px; padding: 30px 25px; color: white; font-size: 20px; font-weight: 600; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 100%; max-height: 70vh; overflow-y: auto; display: block; z-index: 5; word-wrap: break-word; }
        .type-badge { position: absolute; top: 20px; left: 20px; width: 40px; height: 40px; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); border-radius: 50%; display: flex; justify-content: center; align-items: center; z-index: 20; box-shadow: 0 4px 10px rgba(0,0,0,0.3); pointer-events: none; }
        .type-badge i { font-size: 16px; color: white; }
        .gradient-overlay { position: absolute; bottom: 0; left: 0; width: 100%; height: 50%; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; z-index: 2; }
        .state-icon { position: absolute; font-size: 60px; color: rgba(255,255,255,0.8); z-index: 5; opacity: 0; transform: scale(1.5); transition: all 0.2s; pointer-events: none; }
        .paused .state-icon { opacity: 1; transform: scale(1); }
        .heart-pop { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0) rotate(-15deg); font-size: 100px; color: var(--primary); z-index: 50; opacity: 0; pointer-events: none; }
        .heart-pop.animate { animation: popFadeCentered 0.8s ease-out forwards; }
        @keyframes popFadeCentered { 0% { opacity: 0; transform: translate(-50%, -50%) scale(0) rotate(-15deg); } 30% { opacity: 1; transform: translate(-50%, -50%) scale(1.5) rotate(0deg); } 100% { opacity: 0; transform: translate(-50%, -150%) scale(1.5) rotate(0deg); } }
        .loader-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 4; display: none; }
        .dotted-loader { width: 50px; height: 50px; border: 5px dotted #ffffff; border-radius: 50%; animation: spin 5s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .progress-bar-container { width: 100%; height: 3px; background: rgba(255, 255, 255, 0.2); margin-top: 12px; border-radius: 4px; overflow: hidden; pointer-events: none; }
        .progress-bar-fill { height: 100%; width: 0%; background: var(--primary); transition: width 0.15s linear; }
        
        /* Shifted actions-bar up slightly from 80px to 105px */
        .actions-bar { position: absolute; right: 10px; bottom: 105px; display: flex; flex-direction: column; align-items: center; gap: 15px; z-index: 100; }
        
        .action-btn { display: flex; flex-direction: column; align-items: center; cursor: pointer; position: relative; }
        .icon-box { width: 45px; height: 45px; margin-bottom: 5px; display: flex; justify-content: center; align-items: center; transition: transform 0.1s; }
        .action-btn:active .icon-box { transform: scale(0.9); }
        .icon-box i { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
        .action-text { font-size: 12px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .liked i { color: var(--primary); }
        .inline-menu { position: absolute; right: 60px; bottom: -10px; background: #ffffff; color: #000; padding: 0; border-radius: 14px; min-width: 250px; display: none; box-shadow: 0 10px 40px rgba(0,0,0,0.4); transform-origin: bottom right; animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275); text-align: left; z-index: 101; overflow: hidden; }
        .inline-menu.active { display: block; }
        .menu-header { background: #f8f8f8; padding: 10px 15px; border-bottom: 1px solid #eee; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: #888; font-weight: 800; }
        .inline-row { padding: 12px 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f0f0f0; transition: background 0.2s; flex-wrap: nowrap; cursor: pointer; }
        .inline-row:last-child { border-bottom: none; }
        .inline-row i { color: #555; font-size: 14px; width: 18px; text-align: center; }
        .inline-label { font-size: 13px; color: #777; font-weight: 500; white-space: nowrap; }
        .inline-val { font-size: 13px; font-weight: 700; color: #000; margin-left: auto; white-space: nowrap; }
        .inline-val-id { font-family: monospace; font-size: 11px; color: #333; margin-left: auto; padding: 4px 6px; background: #f0f0f0; border-radius: 4px; cursor: pointer; white-space: nowrap; overflow-x: auto; max-width: 140px; }
        @keyframes popIn { from {opacity: 0; transform: scale(0.8);} to {opacity: 1; transform: scale(1);} }
        .info-area { position: absolute; bottom: 35px; left: 15px; right: 15px; z-index: 10; text-align: left; pointer-events: none; padding-bottom: env(safe-area-inset-bottom); }
        .user-badge { display: flex; align-items: center; margin-bottom: 10px; pointer-events: auto; cursor: pointer; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; margin-right: 10px; }
        .username { font-weight: 700; font-size: 16px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); display: flex; align-items: center; }
        .caption { font-size: 14px; line-height: 1.4; color: #eee; text-shadow: 0 1px 2px rgba(0,0,0,0.8); word-wrap: break-word; }
        .sheet-modal { position: fixed; bottom: 0; left: 0; width: 100%; height: 70%; background: var(--dark-sheet); border-radius: 16px 16px 0 0; transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.1, 0.7, 0.1, 1); z-index: 1000; display: flex; flex-direction: column; box-shadow: 0 -5px 30px rgba(0,0,0,0.6); color: white; padding-bottom: env(safe-area-inset-bottom); }
        .sheet-modal.active { transform: translateY(0); }
        .sheet-header { padding: 15px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; font-weight: 700; }
        .close-btn { background: none; border: none; color: white; font-size: 20px; padding: 5px; cursor: pointer; }
        .sheet-body { flex: 1; overflow-y: auto; padding: 20px; }
        .comment-item { display: flex; gap: 12px; margin-bottom: 18px; align-items: center; }
        .c-avatar { width: 36px; height: 36px; border-radius: 50%; object-fit: cover; border: 1px solid #333; background: #444; }
        .c-info { display: flex; flex-direction: column; justify-content: center; flex: 1; }
        .c-name { font-size: 13px; color: #ccc; font-weight: 700; margin-bottom: 3px; }
        .c-text { font-size: 14px; color: white; line-height: 1.3; }
        .input-bar { padding: 15px; border-top: 1px solid #333; display: flex; align-items: center; gap: 10px; background: var(--dark-sheet); }
        .input-bar input { flex: 1; background: #333; border: none; padding: 12px 15px; border-radius: 25px; color: white; outline: none; }
        .send-icon-btn { background: var(--primary); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: none; color: white; cursor: pointer; font-size: 16px; }

        /* PROFILE PAGE STYLES */
        #profile-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 500; display: none; overflow-y: auto; padding-bottom: 40px; }
        .profile-nav { padding: 15px; position: sticky; top: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 501; display: flex; align-items: center; border-bottom: 1px solid #222; }
        .nav-back { color: white; font-size: 20px; padding: 5px 10px 5px 0; cursor: pointer; margin-right: 15px; }
        .nav-title { font-weight: 700; font-size: 18px; }
        .profile-header { padding: 30px 20px; display: flex; flex-direction: column; align-items: center; }
        .p-avatar { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #222; margin-bottom: 15px; object-fit: cover; }
        .p-name { font-size: 22px; font-weight: 700; margin-bottom: 15px; text-align: center; display: flex; align-items: center; gap: 8px; }
        .stats-bar { display: flex; width: 100%; justify-content: space-around; margin-bottom: 20px; padding: 0 10px; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-val { font-weight: 700; font-size: 18px; margin-bottom: 4px; }
        .stat-lbl { font-size: 12px; color: #888; }
        
        .posts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; width: 100%; }
        .grid-item { position: relative; width: 100%; padding-top: 133%; /* 3:4 Aspect Ratio */ background: #111; overflow: hidden; cursor: pointer; }
        .grid-img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .grid-icon { position: absolute; top: 5px; right: 5px; color: white; font-size: 12px; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .grid-views { position: absolute; bottom: 5px; left: 5px; color: white; font-size: 10px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); display: flex; align-items: center; gap: 3px; }

        /* SINGLE POST VIEW */
        #single-post-view { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 600; display: none; }
        .single-close { position: absolute; top: 20px; right: 20px; color: white; font-size: 24px; z-index: 2000; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; cursor: pointer; }

        /* HIDE USER ICON IN SINGLE VIEW AS REQUESTED */
        #single-reel-container .user-badge { display: none !important; }

        /* SPLASH SCREEN STYLES */
        #initial-splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.6s ease, visibility 0.6s;
        }
        .splash-content {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .splash-icon {
            font-size: 60px;
            color: var(--primary);
            margin-bottom: 20px;
            animation: pulse 1.5s infinite ease-in-out;
        }
        .splash-text {
            font-size: 18px;
            font-weight: 700;
            color: white;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* NEW 3D START BUTTON STYLES */
        .start-btn-3d {
            margin-top: 40px;
            padding: 15px 45px;
            font-size: 18px;
            font-weight: 800;
            color: #fff;
            background: var(--primary);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            position: relative;
            box-shadow: 0 7px 0 #b01d3b, 0 10px 20px rgba(0,0,0,0.5);
            transition: all 0.1s;
            display: flex;
            align-items: center;
            gap: 12px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
        }
        .start-btn-3d:active {
            transform: translateY(4px);
            box-shadow: 0 3px 0 #b01d3b, 0 5px 10px rgba(0,0,0,0.5);
        }
        .start-btn-3d i { font-size: 20px; }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* LOGIN AND FOLLOW STYLES */
        #login-state-box {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1500;
            display: flex;
            align-items: center;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px;
            border-radius: 50%;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer;
        }
        #login-state-box img { width: 34px; height: 34px; border-radius: 50%; border: 1px solid #fff; }

        /* ACCOUNT PANEL STYLES */
        #account-panel {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #ffffff;
            color: #000;
            padding: 0;
            border-radius: 16px;
            width: 220px;
            display: none;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transform-origin: top right;
            animation: popIn 0.25s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1501;
            overflow: hidden;
        }
        #account-panel.active { display: block; }
        .ap-user-info { padding: 20px; display: flex; flex-direction: column; align-items: center; text-align: center; gap: 10px; border-bottom: 1px solid #eee; }
        .ap-avatar { width: 60px; height: 60px; border-radius: 50%; border: 2px solid var(--primary); object-fit: cover; }
        .ap-name { font-weight: 700; font-size: 16px; color: #000; }
        .ap-username-tag { font-size: 12px; color: #777; font-weight: 500; }
        .ap-action { padding: 12px 15px; display: flex; align-items: center; gap: 12px; cursor: pointer; transition: background 0.2s; font-size: 14px; font-weight: 600; }
        .ap-action:hover { background: #f8f8f8; }
        .ap-action i { color: #555; width: 18px; text-align: center; }

        .follow-btn {
            background: #0095f6;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            margin-left: 10px;
            cursor: pointer;
            pointer-events: auto;
        }
        .follow-btn.following {
            background: rgba(255,255,255,0.2);
            color: #eee;
        }

        #p-header-follow-btn {
            margin-top: 10px;
            padding: 8px 30px;
            font-size: 14px;
        }

        /* CUSTOM POPUP STYLES */
        .toast-msg {
            position: fixed;
            top: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s, top 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        .toast-msg.show { opacity: 1; top: 150px; } 

        .custom-modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            backdrop-filter: blur(5px);
        }
        .custom-modal-box {
            background: #fff;
            color: #000;
            width: 85%;
            max-width: 320px;
            border-radius: 16px;
            padding: 20px;
            text-align: center;
            animation: modalScale 0.2s ease-out;
        }
        @keyframes modalScale { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { font-weight: 700; font-size: 18px; margin-bottom: 10px; }
        .modal-body { font-size: 14px; color: #666; margin-bottom: 20px; line-height: 1.5; }
        .modal-error { font-size: 12px; color: var(--primary); font-weight: 700; margin-bottom: 15px; display: none; }
        .modal-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: inherit;
            outline: none;
        }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: none;
            font-weight: 700;
            cursor: pointer;
        }
        .btn-cancel { background: #f0f0f0; color: #000; }
        .btn-confirm { background: var(--primary); color: #fff; }

        /* SHARE MODE OVERLAY UI */
        #share-view-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1600;
            display: none;
        }
        .home-btn {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 8px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 40px;
            height: 40px;
            justify-content: center;
        }

        /* NEW SOUND CARD INTEGRATED STYLES (RESIZED & WHITE SQUARE FRAME) */
        .f { width: 38px; height: 38px; background: #FFFFFF; border-radius: 4px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); transition: 0.2s; }
        .f:active { transform: scale(0.96); }
        .f svg { width: 18px; height: 18px; fill: #000; margin-bottom: 2px; transition: 0.3s; }
        .f .mute { display: none; }
        .f.m .note { display: none; }
        .f.m .mute { display: block; fill: var(--primary); }
        .w { display: flex; align-items: center; gap: 2px; height: 10px; }
        .l { width: 2px; height: 3px; background: #000; border-radius: 1px; animation: p 0.8s ease-in-out infinite; transition: 0.3s; }
        @keyframes p { 0%, 100% { height: 3px; } 50% { height: 10px; } }
        .f.m .l { animation-play-state: paused; background: #ccc; }
        
        /* MATERIAL SYMBOL STYLE AS REQUESTED */
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    </style>
</head>
      
<body>

    <!-- INITIAL SPLASH SCREEN WITH 3D START BUTTON -->
    <div id="initial-splash">
        <div class="splash-content">
            <i class="fas fa-clapperboard splash-icon"></i>
            <div class="splash-text">#ùöÇùöéùöõùöüùöéùöõùôµùöéùöéùöç:-ùô¥ùô±ùôºùöÇ-09</div>
            
            <button class="start-btn-3d" id="main-start-btn" onclick="startAppNow()">
                <i class="fas fa-play"></i> ùôæùöôùöéùöó ùöÅùöéùöéùöïùöú
            </button>
        </div>
    </div>

    <!-- CUSTOM TOAST -->
    <div id="custom-toast" class="toast-msg"></div>

    <!-- SHARE VIEW CONTROLS (Floating Home Button) -->
    <div id="share-view-controls">
        <div class="home-btn" onclick="window.location.href = window.location.pathname">
            <i class="fas fa-home"></i>
        </div>
    </div>

    <!-- CUSTOM MODAL -->
    <div id="custom-modal-overlay" class="custom-modal-overlay">
        <div class="custom-modal-box">
            <div id="modal-title" class="modal-title"></div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-error" class="modal-error">Incorrect Username</div>
            <input type="text" id="modal-input" class="modal-input" style="display:none;">
            <div class="modal-btns">
                <button id="modal-cancel" class="modal-btn btn-cancel">Cancel</button>
                <button id="modal-confirm" class="modal-btn btn-confirm">Confirm</button>
            </div>
        </div>
    </div>

    <!-- TOP RIGHT LOGIN STATUS ICON ONLY -->
    <div id="login-state-box" onclick="handleLoginClick()">
        <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" id="login-img">
    </div>

    <!-- ACCOUNT PANEL (SHOWN ON CLICK) -->
    <div id="account-panel">
        <div class="ap-user-info">
            <img src="https://cdn-icons-png.flaticon.com/512/149/149071.png" class="ap-avatar" id="ap-panel-img">
            <div>
                <div class="ap-name" id="ap-panel-name">Guest</div>
                <div class="ap-username-tag" id="ap-panel-id">@guest</div>
            </div>
        </div>
        <div class="ap-action" onclick="openMyProfile()">
            <i class="fas fa-user"></i> My Profile
        </div>
        
        <!-- NEW FEED SETTINGS SECTION -->
        <div class="ap-action" onclick="document.getElementById('feed-sub-options').style.display = document.getElementById('feed-sub-options').style.display === 'none' ? 'block' : 'none'">
            <i class="fas fa-cog"></i> Feed Settings
        </div>
        <div id="feed-sub-options" style="display:none; background: #f9f9f9; border-bottom: 1px solid #eee;">
            <div class="ap-action" onclick="changeFeed('TRENDING')" style="padding-left: 45px; font-size: 13px;"> üî¥TRENDING</div>
            <div class="ap-action" onclick="changeFeed('NEW')" style="padding-left: 45px; font-size: 13px;">üîµ NEW</div>
            <div class="ap-action" onclick="changeFeed('NORMAL')" style="padding-left: 45px; font-size: 13px;">‚ö´ NORMAL</div>
        </div>

        <div class="ap-action" onclick="handleLogout()">
            <i class="fas fa-sign-out-alt"></i> Logout
        </div>
    </div>

    <div id="app-frame">
        <div class="feed-container" id="feed">
            <div class="loader-wrapper" style="display:block">
                <div class="dotted-loader"></div>
            </div>
        </div>
    </div>

    <!-- PROFILE PAGE -->
    <div id="profile-page">
        <div class="profile-nav">
            <i class="fas fa-arrow-left nav-back" onclick="closeProfilePage()"></i>
            <span class="nav-title" id="p-page-name">User</span>
        </div>
        <div class="profile-header">
            <img src="" class="p-avatar" id="p-page-avatar">
            <div class="p-name">
                <span id="p-page-fullname">User</span>
                <span id="p-page-badge"></span>
            </div>
            <div id="profile-follow-container"></div>
            
            <div class="stats-bar" style="margin-top: 20px;">
                <div class="stat-item">
                    <span class="stat-val" id="p-stat-posts">0</span>
                    <span class="stat-lbl">Posts</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="p-stat-followers">0</span>
                    <span class="stat-lbl">Followers</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="p-stat-following">0</span>
                    <span class="stat-lbl">Following</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="p-stat-views">0</span>
                    <span class="stat-lbl">Views</span>
                </div>
            </div>
        </div>
        <div class="posts-grid" id="p-grid"></div>
    </div>

    <!-- SINGLE POST VIEW OVERLAY -->
    <div id="single-post-view">
        <div class="single-close" onclick="closeSinglePost()"><i class="fas fa-times"></i></div>
        <div id="single-reel-container" style="width:100%; height:100%;"></div>
    </div>

    <div id="comments-sheet" class="sheet-modal">
        <div class="sheet-header">
            <span id="c-count">Comments</span>
            <button class="close-btn" onclick="closeSheet()"><i class="fas fa-times"></i></button>
        </div>
        <div class="sheet-body" id="c-list"></div>
        <div class="input-bar">
            <input type="text" id="c-input" placeholder="Add a comment..." autocomplete="off">
            <button class="send-icon-btn" id="c-send"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get, child, update, set, push, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA5FgwyJpsNBTpK6hU0TuJni0duOdULI5M",
            authDomain: "advanced-pri-norw123.firebaseapp.com",
            databaseURL: "https://advanced-pri-norw123-default-rtdb.firebaseio.com",
            projectId: "advanced-pri-norw123",
            storageBucket: "advanced-pri-norw123.firebasestorage.app",
            messagingSenderId: "772396412620",
            appId: "1:772396412620:web:9b4664b473abc075e69c69"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app); 
        const feed = document.getElementById('feed');
        const NORMAL_USER_ICON = "https://cdn-icons-png.flaticon.com/512/149/149071.png";

        window.cachedPosts = []; 
        window.currentUserData = null;
        window.isGlobalMuted = false; // AUDIO UNMUTED BY DEFAULT AS REQUESTED

        const fmt = n => n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(1)+'k' : n;
        
        const timeAgo = (ts) => {
            if (!ts) return "Recently";
            const diff = Date.now() - ts;
            const seconds = Math.floor(diff / 1000);
            if (seconds < 60) return "Just now";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + "m ago";
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + "h ago";
            const days = Math.floor(hours / 24);
            return days + "d ago";
        };

        const getRandomColor = () => {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) { color += letters[Math.floor(Math.random() * 16)]; }
            return color;
        };

        /* UI HELPERS FOR POPUPS */
        window.showToast = function(msg) {
            const toast = document.getElementById('custom-toast');
            toast.innerText = msg;
            toast.classList.add('show');
            setTimeout(() => { toast.classList.remove('show'); }, 3000);
        };

        window.showModal = function({title, body, input = false, confirmText = "Confirm", cancelText = "Cancel", onConfirm}) {
            const overlay = document.getElementById('custom-modal-overlay');
            const t = document.getElementById('modal-title');
            const b = document.getElementById('modal-body');
            const err = document.getElementById('modal-error');
            const inp = document.getElementById('modal-input');
            const btnConfirm = document.getElementById('modal-confirm');
            const btnCancel = document.getElementById('modal-cancel');

            t.innerText = title;
            b.innerText = body;
            err.style.display = 'none';
            inp.style.display = input ? 'block' : 'none';
            inp.value = '';
            btnConfirm.innerText = confirmText;
            btnCancel.innerText = cancelText;

            overlay.style.display = 'flex';

            btnConfirm.onclick = async () => {
                if (input && !inp.value.trim()) return;
                const result = await onConfirm(input ? inp.value.trim() : true);
                if (result === "keep_open") {
                    err.style.display = 'block';
                } else {
                    overlay.style.display = 'none';
                    btnConfirm.onclick = null;
                    btnCancel.onclick = null;
                }
            };
            btnCancel.onclick = () => {
                overlay.style.display = 'none';
                btnConfirm.onclick = null;
                btnCancel.onclick = null;
            };
        };

        // LOGIN HELPERS
        async function attemptLogin(username) {
            if(!username) return;
            try {
                const snapshot = await get(child(ref(db), 'users'));
                if (snapshot.exists()) {
                    const users = snapshot.val();
                    const foundId = Object.keys(users).find(id => users[id].mainAccountUsername === username);
                    if (foundId) {
                        const user = users[foundId];
                        window.currentUserData = { id: foundId, ...user };
                        localStorage.setItem("username", username);
                        updateLoginUI(user);
                        return "success";
                    }
                }
            } catch (e) { console.error(e); }
            return "keep_open"; 
        }

        function updateLoginUI(user) {
            const loginImg = document.getElementById('login-img');
            const panelImg = document.getElementById('ap-panel-img');
            const panelName = document.getElementById('ap-panel-name');
            const panelId = document.getElementById('ap-panel-id');
            
            if(user) {
                const avatar = user.avatar || NORMAL_USER_ICON;
                loginImg.src = avatar;
                panelImg.src = avatar;
                panelName.innerText = user.name || user.mainAccountUsername;
                panelId.innerText = "@" + user.mainAccountUsername;
            } else {
                loginImg.src = NORMAL_USER_ICON;
                panelImg.src = NORMAL_USER_ICON;
                panelName.innerText = "Guest";
                panelId.innerText = "@guest";
            }
        }

        window.handleLoginClick = async function() {
            if(window.currentUserData) {
                const panel = document.getElementById('account-panel');
                panel.classList.toggle('active');
                return;
            }
            showModal({
                title: "Login",
                body: " Enter Your Main  Username:",
                input: true,
                confirmText: "Login",
                onConfirm: async (val) => {
                    const res = await attemptLogin(val);
                    if(res === "success") init(); 
                    return res;
                }
            });
        };

        window.handleLogout = function() {
            localStorage.removeItem("username");
            window.currentUserData = null;
            location.reload();
        };

        window.openMyProfile = function() {
            if(window.currentUserData) {
                document.getElementById('account-panel').classList.remove('active');
                openUserProfile(window.currentUserData.id);
            }
        };

        // Close panel on outside click
        window.addEventListener('click', (e) => {
            const panel = document.getElementById('account-panel');
            const loginBox = document.getElementById('login-state-box');
            if (panel && !panel.contains(e.target) && !loginBox.contains(e.target)) {
                panel.classList.remove('active');
            }
        });

        // FEED FILTER LOGIC
        window.changeFeed = function(type) {
            if (!window.cachedPosts || window.cachedPosts.length === 0) return;
            
            let posts = [...window.cachedPosts];
            
            if (type === 'TRENDING') {
                posts.sort((a, b) => (b.views || 0) - (a.views || 0));
            } else if (type === 'NEW') {
                posts.sort((a, b) => (b.createdAt || b.timestamp || 0) - (a.createdAt || a.timestamp || 0));
            } else {
                // NORMAL - Shuffle
                posts.sort(() => Math.random() - 0.5);
            }

            // Close panel
            document.getElementById('account-panel').classList.remove('active');
            document.getElementById('feed-sub-options').style.display = 'none';

            // Re-render feed
            renderFeedList(posts);
            feed.scrollTop = 0;
        };

        function renderFeedList(posts) {
            const tempFragment = document.createDocumentFragment();
            posts.forEach(p => createReel(p, tempFragment));
            feed.innerHTML = ''; 
            feed.appendChild(tempFragment);
            initObserver(feed);
        }

        // FOLLOW LOGIC
        window.handleFollow = async function(e, targetUserId, btn) {
            if (e) e.stopPropagation();
            if(!window.currentUserData) {
                handleLoginClick();
                return;
            }
            if(window.currentUserData.id === targetUserId) return;

            const isFollowing = btn.classList.contains('following');
            const myId = window.currentUserData.id;

            const updateDB = async (follow) => {
                try {
                    if(!follow) {
                        await set(ref(db, `users/${targetUserId}/followers/${myId}`), null);
                        await set(ref(db, `users/${myId}/following/${targetUserId}`), null);
                        btn.classList.remove('following');
                        btn.innerText = "Follow";
                    } else {
                        await set(ref(db, `users/${targetUserId}/followers/${myId}`), true);
                        await set(ref(db, `users/${myId}/following/${targetUserId}`), true);
                        btn.classList.add('following');
                        btn.innerText = "Following";
                    }
                    const snap = await get(child(ref(db), `users/${myId}`));
                    if(snap.exists()) {
                        window.currentUserData = {id: myId, ...snap.val()};
                    }
                } catch(err) { console.error(err); }
                return "close";
            };

            if(isFollowing) {
                showModal({
                    title: "Unfollow",
                    body: "Do you want to unfollow this user?",
                    confirmText: "Unfollow",
                    onConfirm: () => updateDB(false)
                });
            } else {
                updateDB(true);
            }
        };

        let audioUnlocked = false;
        const unlockAudio = () => {
            if(!audioUnlocked) {
                audioUnlocked = true;
                document.querySelectorAll('video').forEach(v => v.muted = window.isGlobalMuted);
                document.removeEventListener('click', unlockAudio);
                document.removeEventListener('touchstart', unlockAudio);
                feed.removeEventListener('wheel', unlockAudio);
                feed.removeEventListener('scroll', unlockAudio);
            }
        };

        // AUDIO TOGGLE LOGIC
        window.toggleGlobalMute = function(e) {
            if(e) e.stopPropagation();
            if(!audioUnlocked) unlockAudio();
            
            window.isGlobalMuted = !window.isGlobalMuted;
            
            document.querySelectorAll('video').forEach(v => {
                v.muted = window.isGlobalMuted;
            });

            document.querySelectorAll('.f').forEach(card => {
                if (window.isGlobalMuted) card.classList.add('m');
                else card.classList.remove('m');
            });
        };

        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);
        feed.addEventListener('wheel', unlockAudio, {passive: true});
        feed.addEventListener('scroll', unlockAudio, {passive: true});

        feed.addEventListener('scroll', () => {
            document.querySelectorAll('.inline-menu.active').forEach(el => el.classList.remove('active'));
        }, {passive: true});

        // UPDATED ERROR LOGIC FOR "POST REMOVED" USING TRIANGLE ICON
        window.handleMediaError = function(el) {
            const wrapper = el.parentElement;
            if (wrapper) {
                wrapper.innerHTML = `
                <div class="error-container">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Post Unavailable</span>
                </div>`;
            }
        };

        // NEW START APP FUNCTION
        window.startAppNow = function() {
            unlockAudio();
            const splash = document.getElementById('initial-splash');
            if (splash) {
                splash.style.opacity = '0';
                setTimeout(() => { splash.style.visibility = 'hidden'; }, 600);
            }
        }

        async function init() {
            const savedUser = localStorage.getItem("username");
            if(savedUser && !window.currentUserData) {
                await attemptLogin(savedUser);
            } else if (!window.currentUserData) {
                updateLoginUI(null);
            }

            const urlParams = new URLSearchParams(window.location.search);
            const shareId = urlParams.get('id') || window.location.hash.substring(1);

            try {
                const snap = await get(child(ref(db), 'posts'));
                if (snap.exists()) {
                    const data = snap.val();
                    let posts = Object.keys(data).map(k => ({ id: k, ...data[k] }));
                    window.cachedPosts = posts; 
                    
                    if(shareId) {
                        document.getElementById('share-view-controls').style.display = 'block';
                        if(data[shareId]) {
                            let finalPosts = [{ id: shareId, ...data[shareId] }, ...posts.filter(p => p.id !== shareId).sort(() => Math.random() - 0.5)];
                            renderFeedList(finalPosts);
                        } else {
                            // SHOW "CONTENT NOT FOUND" IF ID IS INCORRECT OR NOT FOUND
                            feed.innerHTML = `
                                <div style="height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #000; text-align: center; color: white; padding: 20px;">
                                    <img src="https://files.catbox.moe/17eycr.png" style="width: 150px; height: auto; margin-bottom: 20px;">
                                    <h2 style="font-size: 22px; font-weight: 700;">Content Not Found</h2>
                                </div>`;
                        }
                    } else {
                        renderFeedList([...posts].sort(() => Math.random() - 0.5));
                    }
                }
            } catch (e) { 
                console.error(e); 
            }
        }

        function createReel(post, container) {
            const postLikes = post.likes || {};
            const likesCount = Object.keys(postLikes).length;
            const comments = post.comments || {};
            const comCount = Object.keys(comments).length;
            const avatar = post.user?.avatar || NORMAL_USER_ICON;
            let name = post.user?.name || 'User';
            
            if (name.length > 20) {
                name = name.substring(0, 17) + "...";
            }
            
            const badgeColor = getRandomColor(); 
            const authorId = post.userId || (post.user ? post.user.id : null) || 'unknown';
            
            const isMonetized = post.user?.isMonetized === true;
            const blueTickHtml = isMonetized ? `<img src="https://files.catbox.moe/wjm1eg.png" style="width: 25px; height: 25px; margin-left: 5px; vertical-align: middle;">` : '';

            let likedClass = "";
            if (window.currentUserData && postLikes[window.currentUserData.id]) {
                likedClass = "liked";
            }

            let isFollowing = window.currentUserData?.following?.[authorId];
            const followBtnHtml = (window.currentUserData?.id !== authorId && authorId !== 'unknown' && !isFollowing) ? 
                `<button class="follow-btn" onclick="handleFollow(event, '${authorId}', this)">Follow</button>` : '';

            let displayCaption = post.content || '';
            if (displayCaption.length > 250) displayCaption = displayCaption.substring(0, 250) + "...";

            const reel = document.createElement('div');
            reel.className = 'reel-frame';

            let mediaHtml = '';
            let typeIconClass = '';
            
            const src = post.video || post.image;
            const isVid = (post.image && (post.image.includes('.mp4')||post.image.includes('webm'))) || post.video || (src && src.toLowerCase().includes('.mp3'));
            const isYoutube = src && (src.includes('youtube.com') || src.includes('youtu.be'));
            const isAudioOnly = (post.type === 'audio') || (src && src.toLowerCase().includes('.mp3'));

            if (isAudioOnly) {
                mediaHtml = `
                    <img src="https://files.catbox.moe/xql5x0.png" class="reel-media" style="width:70%; height:auto; object-fit:contain; z-index:3; position:relative;">
                    <video class="reel-media" loop playsinline style="position:absolute; top:0; left:0; width:100%; height:100%; opacity:0;"><source src="${src}" type="video/mp4"></video>
                `;
                typeIconClass = 'fa-music';
            } else if (isYoutube) {
                mediaHtml = `
                <div class="error-container">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Post Unavailable</span>
                </div>`;
                typeIconClass = 'fa-video-slash';
            } else if(isVid) {
                mediaHtml = `<video class="reel-media" loop playsinline onerror="handleMediaError(this)"><source src="${src}" type="video/mp4"></video>`;
                typeIconClass = 'fa-video';
            } else if (src) {
                mediaHtml = `<img src="${src}" class="reel-media" onerror="handleMediaError(this)">`;
                typeIconClass = 'fa-image';
            } else {
                typeIconClass = 'fa-align-left';
                mediaHtml = `<div class="text-post-container"><div class="text-post-box">${post.content || "No Content"}</div></div>`;
            }

            // Visualizer bars template
            const bars = Array(6).fill(0).map((_, i) => `<div class="l" style="animation-delay: -${i * 0.12}s"></div>`).join('');

            // DYNAMIC SOUND CARD CONTENT LOGIC
            let soundBoxInnerHtml = '';
            if (isVid && !isYoutube) {
                soundBoxInnerHtml = `
                    <svg viewBox="0 0 24 24">
                        <path class="note" d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                        <path class="mute" d="M4.27 3L3 4.27l9 9v.28c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4v-1.17l4.73 4.73L21 19.73 4.27 3zM14 7h4V3h-6v5.17l2 2V7z"/>
                    </svg>
                    <div class="w">${bars}</div>
                `;
            } else {
                soundBoxInnerHtml = `<span class="material-symbols-outlined" style="color: #000; font-size: 22px;">music_off</span>`;
            }

            reel.innerHTML = `
                <div class="type-badge" style="border: 3px solid ${badgeColor};">
                    <i class="fas ${typeIconClass}"></i>
                </div>
                <div class="media-wrapper" id="wrap-${post.id}">
                    ${mediaHtml}
                    <div class="loader-wrapper" id="loader-${post.id}"><div class="dotted-loader"></div></div>
                    <div class="state-icon"><i class="fas fa-play"></i></div>
                    <div class="heart-pop"><i class="fas fa-heart"></i></div>
                </div>
                <div class="gradient-overlay"></div>
                <div class="actions-bar">
                    <div class="action-btn ${likedClass}" id="like-btn-${post.id}" onclick="toggleLike(this, '${post.id}')">
                        <div class="icon-box"><i class="fas fa-heart"></i></div>
                        <span class="action-text">${fmt(likesCount)}</span>
                    </div>
                    <div class="action-btn" id="comment-btn-${post.id}" onclick="openComments('${post.id}', '${encodeURIComponent(JSON.stringify(comments))}')">
                        <div class="icon-box"><i class="fas fa-comment-dots"></i></div>
                        <span class="action-text">${fmt(comCount)}</span>
                    </div>
                    <div class="action-btn" onclick="sharePost('${post.id}')">
                        <div class="icon-box"><i class="fas fa-share"></i></div>
                        <span class="action-text">Share</span>
                    </div>
                    <div class="action-btn" style="position:relative">
                        <div class="icon-box" onclick="toggleInlineMenu(this, '${post.id}')"><i class="fas fa-ellipsis-h"></i></div>
                        <span class="action-text">More</span>
                        <div class="inline-menu" id="menu-${post.id}">
                            <div class="menu-header">Post Information</div>
                            <div class="inline-row">
                                <i class="fas fa-eye"></i>
                                <span class="inline-label">Views:</span>
                                <span class="inline-val">${fmt(post.views || 0)}</span>
                            </div>
                            <div class="inline-row">
                                <i class="fas fa-clock"></i>
                                <span class="inline-label">Uploaded:</span>
                                <span class="inline-val">${timeAgo(post.createdAt || post.timestamp || post.lastViewUpdate)}</span>
                            </div>
                            <div class="inline-row" onclick="reportPost()">
                                <i class="fas fa-flag"></i>
                                <span class="inline-label">Report Post</span>
                            </div>
                            <div class="inline-row">
                                <i class="fas fa-hashtag"></i>
                                <span class="inline-label">Post ID:</span>
                                <span class="inline-val-id" onclick="copyId('${post.id}')">${post.id}</span>
                            </div>
                        </div>
                    </div>
                    <div class="action-btn" onclick="window.location.href='https://uraprozx.netlify.app/'">
                        <div class="icon-box"><i class="fas fa-plus-circle"></i></div>
                        <span class="action-text">Add</span>
                    </div>
                    
                    <div class="f ${window.isGlobalMuted ? 'm' : ''}" onclick="toggleGlobalMute(event)">
                        ${soundBoxInnerHtml}
                    </div>

                </div>
                <div class="info-area">
                    <div class="user-badge" onclick="openUserProfile('${authorId}')">
                        <img src="${avatar}" class="avatar">
                        <div class="username">${name}${blueTickHtml} ${followBtnHtml}</div>
                    </div>
                    ${!src && !isVid ? '' : `<div class="caption">${displayCaption}</div>`}
                    ${(isVid && !isYoutube) ? `<div class="progress-bar-container"><div class="progress-bar-fill" id="progress-fill-${post.id}"></div></div>` : ''}
                </div>
            `;
            container.appendChild(reel);

            if(isVid && !isYoutube) {
                const vidEl = reel.querySelector('video');
                const loader = reel.querySelector(`#loader-${post.id}`);
                const progressFill = reel.querySelector(`#progress-fill-${post.id}`);
                vidEl.addEventListener('waiting', () => { if(loader) loader.style.display = 'block'; });
                vidEl.addEventListener('playing', () => { if(loader) loader.style.display = 'none'; });
                vidEl.addEventListener('canplay', () => { if(loader) loader.style.display = 'none'; });
                vidEl.addEventListener('timeupdate', () => {
                    if (vidEl.duration && progressFill) {
                        const pct = (vidEl.currentTime / vidEl.duration) * 100;
                        progressFill.style.width = pct + '%';
                    }
                });
            } else {
                const loader = reel.querySelector(`#loader-${post.id}`);
                if(loader) loader.style.display = 'none';
            }

            const wrapper = reel.querySelector(`#wrap-${post.id}`);
            const video = wrapper.querySelector('video');
            const heartPop = wrapper.querySelector('.heart-pop');
            const likeBtn = reel.querySelector(`#like-btn-${post.id}`);
            let lastTapTime = 0;
            let tapTimeout;

            wrapper.addEventListener('click', (e) => {
                if(e.target.closest('.actions-bar') || e.target.closest('.error-container') || e.target.closest('.follow-btn')) return;
                const now = new Date().getTime();
                const timeDiff = now - lastTapTime;
                if (timeDiff < 300 && timeDiff > 0) {
                    clearTimeout(tapTimeout);
                    heartPop.classList.remove('animate');
                    void heartPop.offsetWidth; 
                    heartPop.classList.add('animate');
                    if (!likeBtn.classList.contains('liked')) toggleLike(likeBtn, post.id);
                } else {
                    tapTimeout = setTimeout(() => {
                        if (video) {
                            if (video.paused) { video.play(); wrapper.classList.remove('paused'); }
                            else { video.pause(); wrapper.classList.add('paused'); }
                        }
                    }, 300);
                }
                lastTapTime = now;
            });
        }

        window.copyId = function(id) { navigator.clipboard.writeText(id).then(() => showToast("Post ID Copied!")); };

        window.reportPost = function() {
            showToast("Thanks For Reporting");
            document.querySelectorAll('.inline-menu').forEach(el => el.classList.remove('active'));
        };

        window.sharePost = async function(id) {
            const shareUrl = "https://uranetworks7-commits.github.io/PostX-Reels-/?id=" + id; 
            if (navigator.share) {
                try { 
                    await navigator.share({ 
                        title: 'Reels Pro', 
                        url: shareUrl 
                    }); 
                } catch (err) {}
            } else { 
                navigator.clipboard.writeText(shareUrl).then(() => showToast("Link copied!")); 
            }
        };

        window.toggleInlineMenu = function(btn, id) {
            const menu = btn.parentElement.querySelector('.inline-menu');
            document.querySelectorAll('.inline-menu').forEach(el => { if(el !== menu) el.classList.remove('active'); });
            if(menu) menu.classList.toggle('active');
        };

        function initObserver(targetContainer) {
            const obs = new IntersectionObserver(entries => {
                entries.forEach(e => {
                    const vid = e.target.querySelector('video');
                    if(!vid) return;
                    if(e.isIntersecting) {
                        vid.muted = window.isGlobalMuted; // RESPECT GLOBAL MUTE STATE
                        vid.play().catch(() => { vid.muted = true; vid.play(); });
                        const wrapper = e.target.querySelector('.media-wrapper');
                        if(wrapper) wrapper.classList.remove('paused');
                    } else { vid.pause(); vid.currentTime = 0; }
                });
            }, {threshold: 0.6, root: targetContainer === feed ? null : targetContainer.parentElement}); 
            targetContainer.querySelectorAll('.reel-frame').forEach(el => obs.observe(el));
        }

        window.toggleLike = async function(btn, postId) {
            if(!window.currentUserData) {
                handleLoginClick();
                return;
            }

            const i = btn.querySelector('i');
            const label = btn.querySelector('.action-text');
            const isLiked = btn.classList.contains('liked');
            
            let currentCount = parseInt(label.innerText.replace('k', '000').replace('M', '000000')) || 0;
            
            btn.classList.toggle('liked');
            
            if(!isLiked) {
                i.style.transform = 'scale(1.4)';
                setTimeout(()=>i.style.transform='scale(1)', 200);
                currentCount++;
            } else {
                currentCount = Math.max(0, currentCount - 1);
            }
            
            label.innerText = fmt(currentCount);

            try {
                const likeRef = ref(db, `posts/${postId}/likes/${window.currentUserData.id}`);
                await set(likeRef, isLiked ? null : true);
            } catch(e) { console.error(e); }
        };

        const cSheet = document.getElementById('comments-sheet');
        const cList = document.getElementById('c-list');
        const cInput = document.getElementById('c-input');
        let currentOpenPostId = null;
        
        function hideCommentsUI() {
            if(cSheet) cSheet.classList.remove('active');
        }

        function hideSinglePostUI() {
            const singleView = document.getElementById('single-post-view');
            const singleContainer = document.getElementById('single-reel-container');
            if(singleView) singleView.style.display = 'none';
            if(singleContainer) {
                singleContainer.innerHTML = '';
                const vids = singleContainer.querySelectorAll('video');
                vids.forEach(v => { v.pause(); v.src = ""; });
            }
            if(document.getElementById('profile-page').style.display !== 'block') {
                document.getElementById('login-state-box').style.display = 'flex';
            }
        }

        function hideProfileUI() {
            const profilePage = document.getElementById('profile-page');
            const appFrame = document.getElementById('app-frame');
            if(profilePage) profilePage.style.display = 'none';
            if(appFrame) appFrame.style.display = 'block';
            document.getElementById('login-state-box').style.display = 'flex';
        }

        window.addEventListener('popstate', (event) => {
            if (cSheet && cSheet.classList.contains('active')) {
                hideCommentsUI();
            } else if (document.getElementById('single-post-view') && document.getElementById('single-post-view').style.display === 'block') {
                hideSinglePostUI();
            } else if (document.getElementById('profile-page') && document.getElementById('profile-page').style.display === 'block') {
                hideProfileUI();
            }
        });

        window.openComments = function(postId, str) {
            currentOpenPostId = postId;
            history.pushState({modal: 'comments'}, '', '');
            const data = JSON.parse(decodeURIComponent(str));
            document.getElementById('c-count').innerText = Object.keys(data).length + ' Comments';
            cList.innerHTML = '';
            if(Object.keys(data).length) {
                Object.entries(data).forEach(([cid, c]) => {
                    const uName = c.user?.name || c.user || 'Guest';
                    const uAvatar = c.user?.avatar || NORMAL_USER_ICON;
                    const uId = c.user?.id || 'unknown';
                    addCom(uName, c.text||c.content, uAvatar, cid, uId);
                });
            } else { cList.innerHTML = '<div style="text-align:center;color:#777;margin-top:20px">No comments yet</div>'; }
            cSheet.classList.add('active');
        };

        window.closeSheet = function() { 
            history.back(); 
        };

        document.getElementById('c-send').addEventListener('click', async () => {
            const txt = cInput.value.trim();
            if(!txt) return;

            if(!window.currentUserData) {
                handleLoginClick();
                return;
            }

            if(cList.innerText.includes('No comments')) cList.innerHTML = '';
            
            const myName = window.currentUserData.name;
            const myAvatar = window.currentUserData.avatar || NORMAL_USER_ICON;
            const myId = window.currentUserData.id;
            
            cInput.value = '';
            cList.scrollTop = cList.scrollHeight;

            try {
                const comRef = ref(db, `posts/${currentOpenPostId}/comments`);
                const newComRef = push(comRef);
                const comId = newComRef.key;
                const commentData = {
                    text: txt,
                    createdAt: Date.now(),
                    user: {
                        id: myId,
                        name: myName,
                        avatar: myAvatar,
                        isMonetized: window.currentUserData.isMonetized || false
                    }
                };
                
                await set(newComRef, commentData);
                addCom(myName, txt, myAvatar, comId, myId);

                const countLabelModal = document.getElementById('c-count');
                let currentCount = parseInt(countLabelModal.innerText) || 0;
                countLabelModal.innerText = (currentCount + 1) + ' Comments';

                const feedCommentLabel = document.querySelector(`#comment-btn-${currentOpenPostId} .action-text`);
                if(feedCommentLabel) {
                    let currentFeedCount = parseInt(feedCommentLabel.innerText.replace('k', '000').replace('M', '000000')) || 0;
                    feedCommentLabel.innerText = fmt(currentFeedCount + 1);
                }

                const post = window.cachedPosts.find(p => p.id === currentOpenPostId);
                if(post) {
                    if(!post.comments) post.comments = {};
                    post.comments[comId] = commentData;
                    const btn = document.getElementById(`comment-btn-${currentOpenPostId}`);
                    if(btn) btn.setAttribute('onclick', `openComments('${currentOpenPostId}', '${encodeURIComponent(JSON.stringify(post.comments))}')`);
                }
            } catch(e) { console.error(e); }
        });

        window.deleteComment = async function(commentId) {
            showModal({
                title: "Delete Comment",
                body: "",
                confirmText: "Delete",
                onConfirm: async () => {
                    try {
                        await remove(ref(db, `posts/${currentOpenPostId}/comments/${commentId}`));
                        const el = document.getElementById(`comment-${commentId}`);
                        if(el) el.remove();
                        
                        const countLabelModal = document.getElementById('c-count');
                        let currentCount = Math.max(0, parseInt(countLabelModal.innerText) - 1);
                        countLabelModal.innerText = currentCount + ' Comments';

                        const feedCommentLabel = document.querySelector(`#comment-btn-${currentOpenPostId} .action-text`);
                        if(feedCommentLabel) {
                            let currentFeedCount = parseInt(feedCommentLabel.innerText.replace('k', '000').replace('M', '000000')) || 0;
                            feedCommentLabel.innerText = fmt(Math.max(0, currentFeedCount - 1));
                        }
                        
                        const post = window.cachedPosts.find(p => p.id === currentOpenPostId);
                        if(post && post.comments) {
                            delete post.comments[commentId];
                            const btn = document.getElementById(`comment-btn-${currentOpenPostId}`);
                            if(btn) btn.setAttribute('onclick', `openComments('${currentOpenPostId}', '${encodeURIComponent(JSON.stringify(post.comments))}')`);
                        }
                        
                        if(cList.children.length === 0) {
                            cList.innerHTML = '<div style="text-align:center;color:#777;margin-top:20px">No comments yet</div>';
                        }
                        showToast("Comment deleted");
                    } catch(e) { console.error(e); }
                    return "close";
                }
            });
        };

        function addCom(n, t, img, cId, cUid) {
            const d = document.createElement('div');
            d.className = 'comment-item';
            d.id = `comment-${cId}`;
            const isMine = window.currentUserData && cUid === window.currentUserData.id;
            d.innerHTML = `
                <img src="${img}" class="c-avatar">
                <div class="c-info">
                    <div class="c-name">${n}</div>
                    <div class="c-text">${t}</div>
                </div>
                ${isMine ? `<i class="fas fa-trash-alt" style="color:#fe2c55; font-size:12px; cursor:pointer; padding: 10px;" onclick="deleteComment('${cId}')"></i>` : ''}
            `;
            cList.appendChild(d);
        }

        const profilePage = document.getElementById('profile-page');
        const appFrame = document.getElementById('app-frame');
        const pGrid = document.getElementById('p-grid');

        window.openUserProfile = async function(uid) {
            history.pushState({modal: 'profile'}, '', '');
            appFrame.style.display = 'none';
            profilePage.style.display = 'block';
            document.getElementById('login-state-box').style.display = 'none'; 
            document.getElementById('account-panel').classList.remove('active');

            document.getElementById('p-page-name').innerText = 'Loading...';
            document.getElementById('p-page-fullname').innerText = '';
            document.getElementById('p-page-badge').innerHTML = '';
            document.getElementById('p-page-avatar').src = NORMAL_USER_ICON;
            document.getElementById('p-stat-posts').innerText = '0';
            document.getElementById('p-stat-followers').innerText = '0';
            document.getElementById('p-stat-following').innerText = '0';
            document.getElementById('p-stat-views').innerText = '0';
            const followContainer = document.getElementById('profile-follow-container');
            followContainer.innerHTML = '';
            pGrid.innerHTML = '';
            if(!uid || uid === 'unknown') return;

            const userPosts = window.cachedPosts.filter(p => {
                const pid = p.userId || (p.user ? p.user.id : null);
                return pid === uid;
            });
            document.getElementById('p-stat-posts').innerText = fmt(userPosts.length);

            try {
                const snapshot = await get(child(ref(db), `users/${uid}`));
                if (snapshot.exists()) {
                    const user = snapshot.val();
                    document.getElementById('p-page-name').innerText = user.name || "User";
                    document.getElementById('p-page-fullname').innerText = user.name || "User";
                    document.getElementById('p-page-avatar').src = user.avatar || NORMAL_USER_ICON;
                    
                    if (user.isMonetized) {
                        document.getElementById('p-page-badge').innerHTML = `<img src="https://files.catbox.moe/wjm1eg.png" style="width: 22px; height: 22px;">`;
                    }

                    if (window.currentUserData && window.currentUserData.id !== uid) {
                        const isFollowing = window.currentUserData.following && window.currentUserData.following[uid];
                        const btn = document.createElement('button');
                        btn.id = 'p-header-follow-btn';
                        btn.className = `follow-btn ${isFollowing ? 'following' : ''}`;
                        btn.innerText = isFollowing ? 'Following' : 'Follow';
                        btn.onclick = (e) => handleFollow(null, uid, btn);
                        followContainer.appendChild(btn);
                    }

                    const f = user.followers ? Object.keys(user.followers).length : 0;
                    const fing = user.following ? Object.keys(user.following).length : 0;
                    document.getElementById('p-stat-followers').innerText = fmt(f);
                    document.getElementById('p-stat-following').innerText = fmt(fing);
                    document.getElementById('p-stat-views').innerText = fmt(user.totalViews || 0);
                }
            } catch(e) { console.error(e); }

            userPosts.forEach(post => {
                const item = document.createElement('div');
                item.className = 'grid-item';
                let thumbContent = '';
                let iconClass = '';
                const src = post.video || post.image;
                const isVid = (post.image && (post.image.includes('.mp4')||post.image.includes('webm'))) || post.video || (src && src.toLowerCase().includes('.mp3'));
                if (isVid) {
                    thumbContent = `<video src="${src}" class="grid-img" style="object-fit:cover" muted preload="metadata"></video>`;
                    iconClass = 'fa-play';
                } else if (src) {
                    thumbContent = `<img src="${src}" class="grid-img">`;
                    iconClass = 'fa-clone';
                } else {
                    thumbContent = `<div style="width:100%;height:100%;background:#222;display:flex;align-items:center;justify-content:center;color:#555;font-size:10px;padding:5px;text-align:center;">${(post.content||'').substring(0,20)}...</div>`;
                    iconClass = 'fa-align-left';
                }
                item.innerHTML = `
                    ${thumbContent}
                    <div class="grid-icon"><i class="fas ${iconClass}"></i></div>
                    <div class="grid-views"><i class="fas fa-play" style="font-size:8px"></i> ${fmt(post.views || 0)}</div>
                `;
                item.onclick = () => openSinglePost(post);
                pGrid.appendChild(item);
            });
        };

        window.closeProfilePage = function() {
            history.back();
        };

        const singleView = document.getElementById('single-post-view');
        const singleContainer = document.getElementById('single-reel-container');

        window.openSinglePost = function(post) {
            history.pushState({modal: 'single'}, '', '');
            document.getElementById('login-state-box').style.display = 'none'; 
            singleContainer.innerHTML = '';
            createReel(post, singleContainer);
            singleView.style.display = 'block';
            const video = singleContainer.querySelector('video');
            if(video) {
                audioUnlocked = true; 
                video.muted = window.isGlobalMuted;
                video.currentTime = 0;
                video.play().catch(e => console.log('Autoplay blocked:', e));
                const wrapper = singleContainer.querySelector('.media-wrapper');
                if(wrapper) wrapper.classList.remove('paused');
            }
            initObserver(singleContainer); 
        };

        window.closeSinglePost = function() {
            history.back();
        };

        init();
    </script>
</body>
</html>